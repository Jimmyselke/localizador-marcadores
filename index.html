<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Marcador más cercano</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      background: #fff;
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 400px;
      width: 90%;
    }

    h1 {
      color: #333;
      font-size: 1.5rem;
    }

    .distance {
      font-size: 1.2rem;
      margin: 1rem 0;
      color: #555;
    }

    .quiz-button {
      display: none;
      margin-top: 1rem;
      padding: 0.75rem 1.5rem;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
    }

    .quiz-button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Marcador más cercano</h1>
    <div class="distance" id="distance">Calculando ubicación...</div>
    <button class="quiz-button" id="quizButton">Iniciar cuestionario</button>
  </div>

  <script>
    const distanceElement = document.getElementById('distance');
    const quizButton = document.getElementById('quizButton');
    const radio = 6371e3; // radio de la Tierra en metros
    const DISTANCIA_LIMITE = 100; // ahora 100 metros

    // Cargar marcadores
    const urls = [
      "https://raw.githubusercontent.com/Jimmyselke/Marcadores-Publicos/main/Denia.json",
      "https://raw.githubusercontent.com/Jimmyselke/Marcadores-Publicos/main/Javea.json"
    ];

    const getJSON = async url => {
      const res = await fetch(url);
      return await res.json();
    };

    Promise.all(urls.map(getJSON)).then((data) => {
      const marcadores = data.flat();

      navigator.geolocation.watchPosition(
        (position) => {
          const { latitude, longitude } = position.coords;

          let marcadorCercano = null;
          let distanciaMinima = Infinity;

          marcadores.forEach(marcador => {
            const lat2 = marcador.lat;
            const lon2 = marcador.lon;

            const φ1 = latitude * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2 - latitude) * Math.PI/180;
            const Δλ = (lon2 - longitude) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            const distancia = radio * c;

            if (distancia < distanciaMinima) {
              distanciaMinima = distancia;
              marcadorCercano = marcador;
            }
          });

          distanciaElement.innerText = `Estás a ${Math.round(distanciaMinima)} m de: ${marcadorCercano.nombre}`;

          if (distanciaMinima <= DISTANCIA_LIMITE) {
            quizButton.style.display = 'inline-block';
            quizButton.onclick = () => {
              window.location.href = marcadorCercano.cuestionario;
            };
          } else {
            quizButton.style.display = 'none';
          }
        },
        (err) => {
          distanceElement.innerText = "No se pudo obtener la ubicación.";
          console.error(err);
        },
        {
          enableHighAccuracy: true
        }
      );
    });
  </script>
</body>
</html>
